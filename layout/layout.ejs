<% 
    var pageTitle = config.title+' || '
    if(page.title) pageTitle+=page.title;
    else if(is_category()) pageTitle+=page.category;
    else if(is_tag()) pageTitle+=page.tag;
    else pageTitle+=config.subtitle;
    var layout = "index"
    if(is_home()){
        layout = "index"
    }else if(is_post()){
        layout = "post"
    }else if(is_category() || page.title=="categories"){
        layout = "categories"
    }else if(is_tag() || page.title=="tags"){
        layout = "tags"
    }else if(is_archive() || is_year() || is_month()){
        layout = "archives"
    }else {
        layout = "post"
    }
    var rootlink = config.root
    site.posts.data.sort(function(a, b){
        return b.date - a.date;
    })
%>
<!DOCTYPE html>
<html lang="<%- config.language %> ">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %></title>
    <meta name="author" content="<%- config.author %>">
    <meta name="description" content="<%- config.description %> ">
    <meta name="keywords" content="<%- config.keywords %> ">
    <link rel="icon" href="<%- rootlink %><%- theme.head_img %>">
    <link rel="stylesheet" href="<%- rootlink %>css/antd.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_8d5l8fzk5b87iudi.css">
    <% if(theme.style == "night"){ %>
    <link rel="stylesheet" href="<%- rootlink %>css/night-theme.css">
    <% }else if(theme.style == "maiden"){ %>
    <link rel="stylesheet" href="<%- rootlink %>css/maiden-theme.css">
    <% }else{ %>
    <link rel="stylesheet" href="<%- rootlink %>css/full-theme.css">
    <% } %>
    <script src="<%- rootlink %>js/vue.js"></script>
    <script src="<%- rootlink %>js/antd.min.js"></script>
</head>

<body>
    <!-- 全局粒子背景 -->
    <canvas id="particle-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; pointer-events: none;"></canvas>

    <div id="loading"
        style="height: 100vh; width: 100%; position: fixed;display: flex;z-index: 200; justify-content: space-between;">
        <div id="loadleft" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div id="loadright" style="width: 50%;background-color: #ffffff;transition: width 0.6s ease-out;"></div>
        <div
            style="position: fixed; height: 100vh; width: 100%;display: flex;justify-content: center;align-items: center;">
            <div id="loadcontent"
                style="width:400px;height:400px;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px#a3ddfb; text-align:center;opacity:1;transition:opacity 0.3s ease-out;">
                <div>
                    <h2>LOADING...</h2>
                    <p>加载中请稍等...</p>
                    <div>
                        <img src="../loadingpicture.gif" alt="loading" height="300px" width="300px">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="layout">
        <transition name="into">
            <div v-show="show_page" style="display: none;">
                <div id="menu_show">
                    <%- include("menu") %>
                </div>

                <div id="main">
                    <%- include(layout) %>
                    <%- include("footer") %>
                </div>
            </div>
        </transition>
    </div>

    <!-- 返回顶部按钮 -->
    <div id="back-to-top" style="position: fixed; bottom: 40px; left: 40px; width: 25px; height: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.3s ease; z-index: 999; opacity: 0.5; color: white; font-size: 14px; font-weight: bold;" onclick="scrollToTop()" onmouseover="this.style.opacity='0.2'; this.style.transform='scale(1.05)';" onmouseout="this.style.opacity='0.5'; this.style.transform='scale(1)';">
        ↑
    </div>

    <script>
        // 返回顶部功能
        window.addEventListener('scroll', function() {
            var backToTop = document.getElementById('back-to-top');
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'flex';
            } else {
                backToTop.style.display = 'none';
            }
        });

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    </script>

    <script>
        // 高对比度粒子效果 - 带边界反弹和生命周期
        (function() {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const minParticles = 20;
            const maxParticles = 50;
            const colors = ['#ff6b9d', '#c44569', '#4a69bd', '#0c2461', '#ffa502', '#ff6348'];
            
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.vx = (Math.random() - 0.5) * 1.4;
                    this.vy = (Math.random() - 0.5) * 1.4;
                    this.radius = Math.random() * 3 + 2;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.baseOpacity = Math.random() * 0.25 + 0.25;
                    this.createdTime = Date.now();
                    this.lifetime = 10000; // 10秒生命周期
                    this.fadeInDuration = 1000; // 1秒淡入
                    this.fadeOutDuration = 1000; // 1秒淡出
                }
                
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // 边界反弹
                    if (this.x - this.radius < 0) {
                        this.x = this.radius;
                        this.vx *= -1;
                    }
                    if (this.x + this.radius > canvas.width) {
                        this.x = canvas.width - this.radius;
                        this.vx *= -1;
                    }
                    if (this.y - this.radius < 0) {
                        this.y = this.radius;
                        this.vy *= -1;
                    }
                    if (this.y + this.radius > canvas.height) {
                        this.y = canvas.height - this.radius;
                        this.vy *= -1;
                    }
                }
                
                getAge() {
                    return Date.now() - this.createdTime;
                }
                
                isExpired() {
                    return this.getAge() > this.lifetime;
                }
                
                getOpacity() {
                    const age = this.getAge();
                    let opacity = this.baseOpacity;
                    
                    // 淡入效果
                    if (age < this.fadeInDuration) {
                        opacity *= age / this.fadeInDuration;
                    }
                    // 淡出效果
                    else if (age > this.lifetime - this.fadeOutDuration) {
                        const fadeProgress = (this.lifetime - age) / this.fadeOutDuration;
                        opacity *= fadeProgress;
                    }
                    
                    return opacity;
                }
                
                draw() {
                    const currentOpacity = this.getOpacity();
                    
                    // 添加高斯模糊效果
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = this.color;
                    
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.globalAlpha = currentOpacity;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    
                    // 重置模糊效果
                    ctx.shadowBlur = 0;
                }
            }
            
            // 初始化粒子
            for (let i = 0; i < 30; i++) {
                particles.push(new Particle());
            }
            
            function manageParticles() {
                // 移除过期粒子
                for (let i = particles.length - 1; i >= 0; i--) {
                    if (particles[i].isExpired()) {
                        particles.splice(i, 1);
                    }
                }
                
                // 维持粒子数量
                if (particles.length < minParticles) {
                    particles.push(new Particle());
                } else if (particles.length < maxParticles && Math.random() < 0.02) {
                    particles.push(new Particle());
                }
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                manageParticles();
                
                particles.forEach(particle => {
                    particle.update();
                    particle.draw();
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
            
            window.addEventListener('resize', function() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        })();
    </script>

    <%- include("script") %>
</body>

</html>